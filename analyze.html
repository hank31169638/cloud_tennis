<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å½±ç‰‡åˆ†æ | æ¡Œçƒå‹•ä½œåˆ†æ</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <header class="nav">
      <div class="brand">ğŸ“ æ¡Œçƒå‹•ä½œåˆ†æ</div>
      <nav>
        <a class="nav-link" href="index.html">é¦–é </a>
        <a class="nav-link" href="analyze.html">åˆ†æå½±ç‰‡</a>
        <a class="nav-link" href="player_data.html">é¸æ‰‹æ•¸æ“š</a>
      </nav>
    </header>

    <main class="page single">
      <section class="panel">
        <h1>æ¡Œçƒå½±ç‰‡åˆ†æ</h1>
        <p class="sub">æ‹–æ›³å½±ç‰‡æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆï¼Œç³»çµ±æœƒåˆ†é¡ç‚º good Â· normal Â· badã€‚</p>

        <div class="dropzone" id="dropzone">
          <input id="fileInput" type="file" accept="video/*" hidden />
          <div class="dz-icon">â¬†</div>
          <div class="dz-text">
            æ‹–æ›³å½±ç‰‡åˆ°é€™è£¡ï¼Œæˆ–
            <button id="chooseBtn" type="button" class="link-btn">é¸æ“‡æª”æ¡ˆ</button>
          </div>
          <div class="file-info" id="fileInfo">å°šæœªé¸æ“‡æª”æ¡ˆ</div>
        </div>

        <div class="actions">
          <button id="uploadBtn" class="primary">ä¸Šå‚³ä¸¦åˆ†æ</button>
          <span id="status" class="status"></span>
        </div>

        <div class="preview hidden" id="preview">
          <video id="videoPreview" controls></video>
        </div>

        <div class="result-card hidden" id="resultCard">
          <div class="result-header">
            <span>åˆ†æçµæœ</span>
            <span class="badge" id="predictedBadge">-</span>
          </div>
          <div class="prob-list" id="probList"></div>
        </div>
      </section>
    </main>

    <footer class="footer">Â© 2025 Table Tennis Analyzer</footer>

    <script>
      const API_BASE = location.protocol.startsWith('http') ? '' : 'http://127.0.0.1:5000';

      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const chooseBtn = document.getElementById('chooseBtn');
      const uploadBtn = document.getElementById('uploadBtn');
      const statusEl = document.getElementById('status');
      const fileInfo = document.getElementById('fileInfo');
      const preview = document.getElementById('preview');
      const videoPreview = document.getElementById('videoPreview');
      const resultCard = document.getElementById('resultCard');
      const predictedBadge = document.getElementById('predictedBadge');
      const probList = document.getElementById('probList');

      let currentFile = null;

      // Prevent browser from opening the file when dropped outside the dropzone
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        window.addEventListener(evt, event => {
          event.preventDefault();
          event.stopPropagation();
        });
      });

      function resetView() {
        fileInfo.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
        statusEl.textContent = '';
        preview.classList.add('hidden');
        videoPreview.removeAttribute('src');
        resultCard.classList.add('hidden');
        probList.innerHTML = '';
        predictedBadge.textContent = '-';
      }

      function loadFile(file) {
        if (!file) {
          currentFile = null;
          resetView();
          return;
        }

        currentFile = file;
        const sizeMB = Math.round((file.size / 1024 / 1024) * 10) / 10;
        fileInfo.textContent = `${file.name} (${sizeMB} MB)`;
        statusEl.textContent = 'æª”æ¡ˆå·²è¼‰å…¥ï¼Œæº–å‚™åˆ†æ';

        const url = URL.createObjectURL(file);
        videoPreview.src = url;
        preview.classList.remove('hidden');
        resultCard.classList.add('hidden');
      }

      chooseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', event => {
        loadFile(event.target.files?.[0] || null);
      });

      ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, event => {
          event.preventDefault();
          event.stopPropagation();
          dropzone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, event => {
          event.preventDefault();
          event.stopPropagation();
          dropzone.classList.remove('dragover');
        });
      });

      dropzone.addEventListener('drop', event => {
        const file = event.dataTransfer?.files?.[0];
        loadFile(file || null);
      });

      function renderProbabilities(probabilities = {}) {
        probList.innerHTML = '';
        const entries = Object.entries(probabilities);
        if (!entries.length) {
          probList.innerHTML = '<div class="error">æ²’æœ‰æ©Ÿç‡è³‡æ–™</div>';
          return;
        }

        entries
          .sort((a, b) => b[1] - a[1])
          .forEach(([label, value]) => {
            const percent = Math.max(0, Math.min(100, value * 100));
            const row = document.createElement('div');
            row.className = 'prob-row';
            row.innerHTML = `
              <div class="prob-name">${label.toUpperCase()}</div>
              <div class="prob-bar"><div style="width:${percent}%"></div></div>
              <div class="prob-val">${percent.toFixed(1)}%</div>
            `;
            probList.appendChild(row);
          });
      }

      uploadBtn.addEventListener('click', async () => {
        if (!currentFile) {
          statusEl.textContent = 'è«‹å…ˆé¸æ“‡æˆ–æ‹–æ›³å½±ç‰‡';
          return;
        }

        statusEl.textContent = 'ä¸Šå‚³èˆ‡åˆ†æä¸­...';
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('file', currentFile);

        try {
          const response = await fetch(`${API_BASE}/analyze`, {
            method: 'POST',
            body: formData
          });
          const data = await response.json();

          if (!response.ok) {
            statusEl.textContent = data.error || 'åˆ†æå¤±æ•—';
            resultCard.classList.remove('hidden');
            predictedBadge.textContent = 'ERROR';
            probList.innerHTML = `<div class="error">${data.error || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
            return;
          }

          statusEl.textContent = 'åˆ†æå®Œæˆ';
          predictedBadge.textContent = (data.predicted_class || '-').toUpperCase();
          renderProbabilities(data.probabilities);
          resultCard.classList.remove('hidden');
        } catch (error) {
          console.error(error);
          statusEl.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªä¼ºæœå™¨å·²å•Ÿå‹•';
        } finally {
          uploadBtn.disabled = false;
        }
      });

      resetView();
    </script>
  </body>
</html>